package backend;import game.core.Board;import game.core.Move;import java.util.ArrayList;import java.util.List;public final class JsonRecorder implements GameListener{    private long seed;    private int expectedStepIndex; // START is 0, first move is 1    private final List<GameRecording.Step> steps = new ArrayList<>();    private GameRecording.Meta meta;    @Override    public void onInit(long seed, Board initialState, int initialScore) {        this.seed = seed;        // reset per game        this.expectedStepIndex = 1;        this.meta = null;        this.steps.clear();        // step 0 is the initial state        steps.add(new GameRecording.Step(0, "START", initialScore, flatten(initialState)));    }    @Override    public void onStep(int stepIndex, Move move, Board boardState, int afterScore) {        if (stepIndex != expectedStepIndex) {            throw new AssertionError("Expected step " + expectedStepIndex + " but got " + stepIndex);        }        steps.add(new GameRecording.Step(stepIndex, move.name(), afterScore, flatten(boardState)));        expectedStepIndex++;    }    @Override    public void onGameOver(Board finalState, int finalScore, int stepsCount) {        int maxTile = finalState.getMaxTile();        boolean reached2048 = maxTile >= 2048;        this.meta = new GameRecording.Meta(seed, finalScore, stepsCount, maxTile, reached2048);    }    public GameRecording build() {        if (steps.isEmpty()) {            throw new IllegalStateException("Recorder was never initialized (onInit not called).");        }        if (meta == null) {            throw new IllegalStateException("Recorder was not finalized (onGameOver not called).");        }        return new GameRecording(meta, List.copyOf(steps));    }    private int[] flatten(Board b) {        int n = b.getDimension();        int[] out = new int[n * n];        for (int r = 0; r < n; r++) {            for (int c = 0; c < n; c++) {                out[r * n + c] = b.get(r, c);            }        }        return out;    }}